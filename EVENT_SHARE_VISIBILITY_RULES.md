# äº‹ä»¶åˆ†äº«å¯è§æ€§è§„åˆ™ï¼ˆä¿®æ­£ç‰ˆï¼‰

## 0. æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»ç»Ÿä¸€ï¼‰

### 0.1 å¯è§æ€§åˆ¤å®šå…ˆäº UI æ¸²æŸ“
- å…ˆåˆ¤å®š **"æ˜¯å¦å¯è§"**ï¼Œå†å†³å®š **"èƒ½åšä»€ä¹ˆæŒ‰é’®/åŠ¨ä½œ"**ã€‚

### 0.2 èº«ä»½ä¼˜å…ˆçº§
- èº«ä»½å¯èƒ½é‡å ï¼ˆå¥½å‹+è¢«åˆ†äº«è€…+ç¾¤æˆå‘˜ç­‰ï¼‰ï¼Œå¿…é¡»ç”¨ä¼˜å…ˆçº§å†³å®šæœ€ç»ˆèº«ä»½ã€‚

### 0.3 é¢œè‰²è§„åˆ™ç»Ÿä¸€
- é¢œè‰²åªç”±**"æ¥æº"**å†³å®šï¼Œå‚ä¸çŠ¶æ€åªå½±å“æ·±æµ…ï¼Œä¸è¦åœ¨ä¸åŒé¡µé¢ç”¨ä¸åŒé¢œè‰²é€»è¾‘ã€‚
- **é¢œè‰²æ ‡å‡†**ï¼š
  - å¥½å‹ / éå¥½å‹ / ä¸ªäººå•ä¸€åˆ†äº«ï¼ˆdirect share / link shareï¼‰ï¼ **ç»¿è‰²** `.green`
  - ç¤¾ç¾¤æ´»åŠ¨ï¼ **è“è‰²** `.blue`
  - è‡ªå·±åˆ›å»ºï¼ **çº¢è‰²** `.red`ï¼ˆä¿ç•™ï¼‰
  - å·²ç»“æŸï¼ **ç°è‰²** `.gray`ï¼ˆä¿ç•™ï¼‰

### 0.4 å­—æ®µå‘½åç»Ÿä¸€ï¼ˆé‡è¦ï¼‰
- **é—®é¢˜**ï¼šå½“å‰å­˜åœ¨ `event.isOpenChecked`ï¼ˆBoolï¼‰å’Œ `event.openChecked`ï¼ˆIntï¼‰æ··ç”¨
- **ä¿®æ­£å»ºè®®**ï¼šç»Ÿä¸€æˆä¸¤ä¸ªæ˜ç¡®å­—æ®µï¼ˆå¼ºçƒˆå»ºè®®ï¼‰
  - `event.visibilityFriends: Bool` - æ˜¯å¦å¯¹å¥½å‹å…¬å¼€
  - `event.visibilityGroup: Bool` - æ˜¯å¦å¯¹ç¤¾ç¾¤å…¬å¼€ï¼ˆæˆ– `visibilityGroupLevel` æœªæ¥æ‰©å±•ï¼‰

## 1. è§‚çœ‹è€…èº«ä»½ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼Œå”¯ä¸€çœŸç›¸ï¼‰

åŒä¸€ç”¨æˆ·æ»¡è¶³å¤šä¸ªæ¡ä»¶æ—¶ï¼Œå–ä¼˜å…ˆçº§æ›´é«˜è€…ã€‚

1. **åˆ›å»ºè€… Creator**
2. **ç¤¾ç¾¤ç®¡ç†è€… Group Admin/Owner**ï¼ˆä»…å½“äº‹ä»¶å±äºè¯¥ç¤¾ç¾¤ä¸”å¯¹ç¤¾ç¾¤å…¬å¼€ï¼‰
3. **è¢«åˆ†äº«è€… Shared Recipient**ï¼ˆå«é‚€è¯·é“¾æ¥éªŒè¯é€šè¿‡ï¼‰
4. **ç¤¾ç¾¤æˆå‘˜ Group Member**ï¼ˆæ™®é€šæˆå‘˜ï¼‰ï¼ˆä»…å½“äº‹ä»¶å±äºè¯¥ç¤¾ç¾¤ä¸”å¯¹ç¤¾ç¾¤å…¬å¼€ï¼‰
5. **å¥½å‹ Friend**ï¼ˆä»…å½“å¯¹å¥½å‹å…¬å¼€ï¼‰
6. **é™Œç”Ÿäºº Stranger**

## 2. å¯è§æ€§åˆ¤å®šï¼ˆæ˜¯å¦èƒ½çœ‹åˆ°è¿™æ¡äº‹ä»¶ï¼‰

### 2.1 åˆ›å»ºè€…ï¼ˆCreatorï¼‰

- **æ¡ä»¶**: `event.creatorOpenid == currentUserId`
- **å¯è§æ€§**: âœ… **å¯è§**ï¼ˆå®Œå…¨å¯è§ï¼‰

### 2.2 ç¤¾ç¾¤å¯è§ï¼ˆGroup Member / Admin / Ownerï¼‰

- **æ¡ä»¶**:
  - `event.groupId != nil`
  - å½“å‰ç”¨æˆ·å±äºè¯¥ç¤¾ç¾¤ï¼ˆ`groupId âˆˆ userGroups`ï¼‰
  - ä¸”äº‹ä»¶å¯¹ç¤¾ç¾¤å…¬å¼€ï¼ˆ`event.openChecked == 1` æˆ–ç­‰ä»·å­—æ®µï¼‰
- **å¯è§æ€§**: âœ… **å¯è§**

> **æ³¨**ï¼šå¦‚æœä½ æœªæ¥è¦æ”¯æŒ"ç¤¾ç¾¤ç§å¯†æ´»åŠ¨"ï¼Œè¿™é‡Œè¦åŠ ä¸€å±‚ role æˆ– activityType æ§åˆ¶ã€‚

### 2.3 è¢«å•ç‹¬åˆ†äº«/é‚€è¯·é“¾æ¥ï¼ˆShared Recipient / Invite Linkï¼‰

- **æ¡ä»¶**ï¼ˆä»»ä¸€æˆç«‹ï¼‰:
  - `event_shares` ä¸­å­˜åœ¨è®°å½•ï¼š`receiverId == currentUserId && eventId == event.id`
  - æˆ–é€šè¿‡ `event_invites`/`InviteLinkManager` éªŒè¯é€šè¿‡ï¼ˆé“¾æ¥æœ‰æ•ˆä¸”å½“å‰ç”¨æˆ·è¢«æˆæƒï¼‰
- **å¯è§æ€§**: âœ… **å¯è§**

> **å¤‡æ³¨**ï¼šå³ä½¿ä¸æ˜¯å¥½å‹ã€ä¹Ÿä¸æ˜¯ç¤¾ç¾¤æˆå‘˜ï¼Œåªè¦å±äº"è¢«åˆ†äº«è€…"ï¼Œåœ¨è¡Œäº‹å†ä¸­**æ°¸è¿œå¯è§**ã€‚

### 2.4 å¥½å‹å¯è§ï¼ˆFriendï¼‰

- **æ¡ä»¶**:
  - `FriendManager.shared.isFriend(with: event.creatorOpenid) == true`
  - ä¸”äº‹ä»¶å…¬å¼€ç»™å¥½å‹ï¼š`event.isOpenChecked == true`ï¼ˆæˆ–ç­‰ä»·å­—æ®µï¼‰
- **å¯è§æ€§**: âœ… **å¯è§**

### 2.5 é™Œç”Ÿäººï¼ˆStrangerï¼‰

- **æ¡ä»¶**: ä»¥ä¸Šéƒ½ä¸æ»¡è¶³
- **å¯è§æ€§**: âŒ **ä¸å¯è§**ï¼ˆä¸åº”å‡ºç°åœ¨åˆ—è¡¨/æ—¥å†ï¼›è‹¥é€šè¿‡é“¾æ¥è¿›å…¥åˆ™æ˜¾ç¤ºæ— æƒé™ï¼‰

## 3. æƒé™ä¸åŠŸèƒ½ï¼ˆçœ‹åˆ°ä»¥åèƒ½åšä»€ä¹ˆï¼‰

### 3.1 åˆ›å»ºè€…ï¼ˆCreatorï¼‰

- âœ… æŸ¥çœ‹è¯¦æƒ…
- âœ… ç¼–è¾‘äº‹ä»¶
- âœ… åˆ†äº«äº‹ä»¶
- âœ… åˆ é™¤äº‹ä»¶ï¼ˆè‹¥äº§å“å…è®¸ï¼‰

### 3.2 ç¤¾ç¾¤ç®¡ç†è€…ï¼ˆGroup Owner / Adminï¼‰

- âœ… æŸ¥çœ‹è¯¦æƒ…
- âœ… ç¼–è¾‘äº‹ä»¶ï¼ˆå½“äº‹ä»¶å±äºç¤¾ç¾¤æ´»åŠ¨æ—¶ï¼‰
- âœ… åˆ é™¤äº‹ä»¶ï¼ˆå½“äº‹ä»¶å±äºç¤¾ç¾¤æ´»åŠ¨æ—¶ï¼‰
- âœ… åˆ†äº«äº‹ä»¶

> **æ³¨æ„**ï¼šå¦‚æœäº‹ä»¶æ˜¯"ä¸ªäººäº‹ä»¶ä½†å¸¦ groupId"è¿™ç§å¼‚å¸¸ç»“æ„ï¼Œå»ºè®®ä»¥"æ˜¯å¦ä¸ºç¤¾ç¾¤æ´»åŠ¨"å­—æ®µå†åšçº¦æŸï¼Œé¿å…ç®¡ç†å‘˜è¯¯åˆ ç§äººäº‹ä»¶ã€‚

### 3.3 è¢«åˆ†äº«è€…ï¼ˆShared Recipient / Invite Linkï¼‰

- âœ… æŸ¥çœ‹è¯¦æƒ…
- âœ… å‚ä¸ / ä¸å‚ä¸
- âŒ ç¼–è¾‘
- âŒ åˆ é™¤
- âŒ åˆ†äº«ï¼ˆé™¤éä½ é¢å¤–å…è®¸"è½¬åˆ†äº«"ï¼Œè§ 6.2ï¼‰

### 3.4 ç¤¾ç¾¤æ™®é€šæˆå‘˜ï¼ˆGroup Memberï¼‰

- âœ… æŸ¥çœ‹è¯¦æƒ…
- âœ… å‚ä¸ / ä¸å‚ä¸
- âŒ ç¼–è¾‘ï¼ˆé™¤éä¹Ÿæ˜¯åˆ›å»ºè€…ï¼‰
- âŒ åˆ é™¤ï¼ˆé™¤éä¹Ÿæ˜¯åˆ›å»ºè€…ï¼‰
- âœ… åˆ†äº«ï¼ˆä»…å½“åˆ›å»ºè€…å…è®¸ï¼Œè§ 6.2ï¼‰

### 3.5 å¥½å‹ï¼ˆFriendï¼‰

- âœ… æŸ¥çœ‹è¯¦æƒ…
- âœ… å‚ä¸ / ä¸å‚ä¸ï¼ˆä½ æ–‡æ¡£éœ€è¦è¿™ä¸ªæŒ‰é’®ï¼Œæ‰€ä»¥ä¿ç•™ï¼‰
- âŒ ç¼–è¾‘
- âŒ åˆ é™¤
- âœ… åˆ†äº«ï¼ˆä»…å½“åˆ›å»ºè€…å…è®¸ï¼Œè§ 6.2ï¼‰

### 3.6 é™Œç”Ÿäººï¼ˆStrangerï¼‰

- âŒ ä¸å¯è§
- è‹¥é€šè¿‡æ— æ•ˆé“¾æ¥è®¿é—®ï¼šæ˜¾ç¤º"æ— æƒé™/é“¾æ¥æ— æ•ˆ"ï¼Œå¯æä¾›"åŠ å¥½å‹"å…¥å£ï¼ˆå¯é€‰ï¼‰

## 4. å‚ä¸çŠ¶æ€ï¼ˆParticipation Statusï¼‰

### 4.1 çŠ¶æ€å­˜å‚¨ï¼ˆç»Ÿä¸€æ¥æºï¼‰

- **æ•°æ®æº**: `event_shares.status`
- **å…è®¸å€¼**:
  - `"shared"`ï¼šå·²åˆ†äº«ä½†æœªè¡¨æ€ï¼ˆåˆå§‹æ€ï¼‰
  - `"joined"`ï¼šå‚ä¸
  - `"declined"`ï¼šä¸å‚ä¸

### 4.2 æŸ¥è¯¢é€»è¾‘ï¼ˆé¿å…å…¬å¼€äº‹ä»¶æŸ¥ä¸åˆ°è®°å½•ï¼‰

- è‹¥æŸ¥è¯¢ä¸åˆ° `event_shares` è®°å½•ï¼šè§†ä¸º **æœªè¡¨æ€**ï¼ˆç­‰ä»· `"shared"`ï¼‰

> **é‡ç‚¹**ï¼šå¥½å‹å…¬å¼€/ç¤¾ç¾¤å…¬å¼€çš„äº‹ä»¶ï¼Œåˆæ¬¡å¯èƒ½æ²¡æœ‰ `event_shares` è®°å½•ã€‚UI ä»ç„¶è¦èƒ½æ˜¾ç¤º"å‚ä¸"æŒ‰é’®ï¼Œç‚¹å‡»åå†å†™å…¥/æ›´æ–° `event_shares`ã€‚

### 4.3 å†™å…¥é€»è¾‘ï¼ˆå¿…é¡» Upsertï¼‰

å½“ç”¨æˆ·ç‚¹å‡»"å‚ä¸/ä¸å‚ä¸"ï¼Œå¿…é¡» upsert ä¸€æ¡ `event_shares`ï¼š

- `eventId`
- `receiverId`
- `creatorId`ï¼ˆå»ºè®®å­˜ï¼Œä¾¿äºç´¢å¼•/å®¡è®¡ï¼‰
- `status` = `joined`/`declined`
- `source` = `friend` | `group` | `direct` | `link`ï¼ˆå»ºè®®å­˜ï¼Œä¾¿äºé¢œè‰²æ¥æºä¸ç»Ÿè®¡ï¼‰
- `updatedAt`

## 5. UI æ˜¾ç¤ºè§„åˆ™

### 5.1 EventShareView åº•éƒ¨æŒ‰é’®æ ï¼ˆæŒ‰èº«ä»½æ¸²æŸ“ï¼‰

#### Creator
```
[åˆ†äº«]
```
- åˆ†äº«æŒ‰é’®ï¼šä¸»è¦æŒ‰é’®æ ·å¼ï¼ˆ`.borderedProminent`ï¼‰

#### Group Owner/Admin
```
[ğŸ—‘ï¸ åˆ é™¤] [âœï¸ ç¼–è¾‘] [åˆ†äº«]
```
- åˆ é™¤æŒ‰é’®ï¼šä½¿ç”¨ `trash` iconï¼Œæ ·å¼è¾ƒä¸æ˜¾çœ¼
- ç¼–è¾‘æŒ‰é’®ï¼šä½¿ç”¨ `pencil` icon
- åˆ†äº«æŒ‰é’®ï¼šä¸»è¦æŒ‰é’®æ ·å¼

#### Shared Recipient / Friend / Group Member
```
[å‚ä¸] [ä¸å‚ä¸]
```
- å‚ä¸æŒ‰é’®ï¼šä¸»è¦æŒ‰é’®æ ·å¼ï¼ˆ`.borderedProminent`ï¼‰
- ä¸å‚ä¸æŒ‰é’®ï¼šæ¬¡è¦æŒ‰é’®æ ·å¼ï¼ˆ`.bordered`ï¼‰
- æˆ–åšæˆä¸€ä¸ªåˆ‡æ¢æŒ‰é’®ï¼ˆæ¨èï¼‰

#### Stranger
```
ï¼ˆæ˜¾ç¤º"æ— æƒé™"æç¤ºï¼‰
```
- ä¸æ˜¾ç¤ºæ“ä½œæŒ‰é’®
- å¯æä¾›"æ·»åŠ åˆ›å»ºè€…ä¸ºå¥½å‹"å…¥å£ï¼ˆå¯é€‰ï¼‰

> **æ³¨æ„**ï¼šåˆ†äº«æŒ‰é’®ç»ä¸èƒ½å…¨å‘˜æ˜¾ç¤ºã€‚åªæœ‰ Creator /ï¼ˆå…è®¸çš„ï¼‰Group Admin/Owner /ï¼ˆåˆ›å»ºè€…å…è®¸è½¬åˆ†äº«çš„ï¼‰Friend/Group Member æ‰èƒ½æ˜¾ç¤ºã€‚

## 6. è¡Œäº‹å†æ˜¾ç¤ºé¢œè‰²è§„åˆ™

### 6.1 é¢œè‰²æ¥æºï¼ˆå”¯ä¸€æ ‡å‡†ï¼‰

1. **è‡ªå·±åˆ›å»ºçš„äº‹ä»¶**ï¼šçº¢è‰² `.red`
2. **ç¤¾ç¾¤æ´»åŠ¨**ï¼ˆgroup å¯è§ï¼‰ï¼šè“è‰² `.blue`
3. **å¥½å‹å¯è§ / éå¥½å‹å•ä¸€åˆ†äº« / é‚€è¯·é“¾æ¥ / ä¸ªäººå•ä¸€åˆ†äº«**ï¼šç»¿è‰² `.green`
4. **å·²ç»“æŸ**ï¼šç°è‰² `.gray`ï¼ˆè¦†ç›–ä»¥ä¸Šé¢œè‰²ï¼‰

### 6.2 å‚ä¸çŠ¶æ€åªå½±å“æ·±æµ…ï¼ˆå»ºè®®ï¼‰

- `"joined"`ï¼šæ­£å¸¸ä¸é€æ˜ï¼ˆ`opacity: 1.0`ï¼‰
- `"shared"` æˆ–æ— è®°å½•ï¼šåŠé€æ˜ï¼ˆ`opacity: 0.5`ï¼‰
- `"declined"`ï¼šæ›´æ·¡ï¼ˆ`opacity: 0.25`ï¼‰æˆ–ç°é˜¶ï¼ˆç”±ä½ å†³å®šï¼‰

> **è¿™æ ·ä½ ä¸ä¼šå†å‡ºç°"åŒç±»äº‹ä»¶ä¸åŒé¡µé¢é¢œè‰²å†²çª"**ã€‚

## 7. æ•°æ®æŸ¥è¯¢éœ€æ±‚ï¼ˆæŒ‰åˆ¤å®šé¡ºåºï¼Œæœ€çœèƒ½è€—ï¼‰

1. **å½“å‰ç”¨æˆ·**: `currentUserId = userManager.userOpenId`
2. **åˆ›å»ºè€…åˆ¤æ–­**: `isCreator = event.creatorOpenid == currentUserId`
3. **group åˆ¤æ–­**ï¼ˆè‹¥ `event.groupId != nil`ï¼‰:
   ```swift
   let userGroups = try await GroupManager.shared.getUserGroups(userId: currentUserId)
   let groupIds = Set(userGroups.compactMap { $0.id })
   let isGroupMember = event.groupId != nil && groupIds.contains(event.groupId!)
   
   // è‹¥éœ€è§’è‰²
   if let groupId = event.groupId {
       let group = try await GroupManager.shared.getGroup(groupId: groupId)
       let isOwner = group.isOwner(userId: currentUserId)
       let isAdmin = group.isAdmin(userId: currentUserId)
   }
   ```
4. **å¥½å‹åˆ¤æ–­**: `isFriend = FriendManager.shared.isFriend(with: event.creatorOpenid)`
5. **share è®°å½•**:
   ```swift
   db.collection("event_shares")
     .whereField("eventId", isEqualTo: event.id)
     .whereField("receiverId", isEqualTo: currentUserId)
     .getDocuments()
   ```
6. **é‚€è¯·é“¾æ¥éªŒè¯**ï¼ˆä»…å½“é€šè¿‡é“¾æ¥è¿›å…¥æ—¶æ‰åšï¼‰:
   - `InviteLinkManager` / `event_invites` éªŒè¯

## 8. å®ç°æ³¨æ„äº‹é¡¹ï¼ˆé˜²æ­¢"æŒ‰é’®/é¢œè‰²ä¹±"å†å‘ç”Ÿï¼‰

1. **å…ˆç®—èº«ä»½ `viewerRole`ï¼Œå†æ¸²æŸ“åº•éƒ¨æŒ‰é’®**ï¼ˆæŒ‰é’®é€»è¾‘åªçœ‹ `viewerRole`ï¼‰
2. **é¢œè‰²åªçœ‹ `accessSource`ï¼Œä¸çœ‹ `viewerRole`**ï¼ˆ`source=groupâ†’è“`ï¼Œå…¶ä»–åˆ†äº«â†’ç»¿ï¼‰
3. **å…¬å¼€äº‹ä»¶æ²¡æœ‰ share è®°å½•æ—¶ï¼ŒçŠ¶æ€é»˜è®¤ `shared`/æœªè¡¨æ€**
4. **æ‰€æœ‰å†™å…¥å‚ä¸çŠ¶æ€éƒ½èµ° upsertï¼Œé¿å…é‡å¤æ–‡æ¡£ä¸çŠ¶æ€é”™ä¹±**
5. **å¼‚æ­¥æŸ¥è¯¢**: æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢éƒ½åº”è¯¥æ˜¯å¼‚æ­¥çš„
6. **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨ `@State` ç®¡ç†è§‚çœ‹è€…ç±»å‹å’Œå‚ä¸çŠ¶æ€
7. **æƒé™æ£€æŸ¥**: åœ¨æ˜¾ç¤º UI ä¹‹å‰å…ˆæ£€æŸ¥æƒé™
8. **é”™è¯¯å¤„ç†**: å¤„ç†ç½‘ç»œé”™è¯¯å’Œæƒé™é”™è¯¯
9. **ç¼“å­˜ä¼˜åŒ–**: è€ƒè™‘ç¼“å­˜å¥½å‹å…³ç³»å’Œåˆ†äº«è®°å½•ä»¥æé«˜æ€§èƒ½

## 9. å­—æ®µå‘½åå»ºè®®

### å½“å‰é—®é¢˜
- `event.isOpenChecked`ï¼ˆBoolï¼‰å’Œ `event.openChecked`ï¼ˆIntï¼‰æ··ç”¨
- åœ¨ä¸åŒé¡µé¢å¯èƒ½å†™å‡ºä¸¤å¥—åˆ¤æ–­é€»è¾‘

### å»ºè®®ä¿®æ­£
```swift
struct Event {
    // æ›¿æ¢ openChecked/isOpenChecked
    var visibilityFriends: Bool = false  // æ˜¯å¦å¯¹å¥½å‹å…¬å¼€
    var visibilityGroup: Bool = false   // æ˜¯å¦å¯¹ç¤¾ç¾¤å…¬å¼€
    
    // æˆ–æœªæ¥æ‰©å±•
    // var visibilityGroupLevel: VisibilityLevel = .none
    // enum VisibilityLevel {
    //     case none, members, admins, owner
    // }
}
```

è¿™æ ·å¯ä»¥ï¼š
- ç»Ÿä¸€åˆ¤æ–­é€»è¾‘
- é¿å…åœ¨ä¸åŒ View/ViewModel é‡Œå†™ä¸¤å¥—åˆ¤æ–­
- æœªæ¥æ‰©å±•æ›´å®¹æ˜“ï¼ˆå¦‚æ”¯æŒ"ä»…ç®¡ç†å‘˜å¯è§"ï¼‰
